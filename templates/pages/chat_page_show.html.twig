{% extends 'base.html.twig' %}

{% block title %}Chat{% endblock %}

{% block chat %}

{% set username = user.username %}
{% set firstName = user.firstName %}
{% set lastName = user.lastName %}

{% set url1 = asset('/images/user_icon.png') %}
{% set url2 = asset('/images/gear_icon.png') %}
{% set url3 = asset('/images/feed_icon.png')  %}
{% set url4 = asset('/images/team_icon.png') %}
{% set url5 = asset('/images/close_icon.png') %}

{% set path1 = "/profile" %}
{% set path2 = "/settings" %}
{% set path3 = "/feed"  %}
{% set path4 = "/people" %}
{% set path5 = "/logout" %}


<div class="page--chat">
    <div class="section__profile">
         {% include 'elements/profile_tab.html.twig' with {'username': username,
                        'lastName' : lastName, 'id' : user.id, 'firstName' : firstName} %} 
        <div class="profile__actions">
            {% include "elements/sidebar_left.html.twig"  with {'url1': url1,
            'url2':url2, 'url3':url3, 'url4':url4, 'text1':'Profile', 'text2':'Settings',
            'text3':'Feed', 'text4':'Find people', 'text5':'Logout', 'path1':path1, 'path2':path2, 'path3':path3, 
            'path4':path4, 'path5':path5} %}
        </div>
    </div>
    <div class="section__chat">
       {% if conversations|length > 0 %}
        <div class="chat__sidebar">
            <div class="chat__tab">
            {% for otherUser in otherUsers %}
                {% include 'elements/chat_profile_tab.html.twig' with {'username': otherUser.username, 'lastName' : otherUser.lastName, 'id' : otherUser.id, 'firstName' : otherUser.firstName} %}
            {% endfor %}
            </div>
        </div>
        <div class="chat__window">
            <div class="window__messages">
                {% for message in conversation.getMessages() %}
                    {% if message.getUserId()[0].id == user.id %}
                        <div class="message--current">
                            <span>{{message.getContent()}}</span>
                        </div>
                    {% else %}
                        <div class="message--other">
                            <span>{{message.getContent()}}</span>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="window__input">{{ form(sendForm, {'id': 'send_message_form'}) }}</div>
        </div>
        {% else %}
            <h1 class="initialized--none">No conversations initialized</h1>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const messageForm = document.querySelector(".window__input form");
    const messageContainer = document.querySelector(".window__messages");
    const conversationId = {{ conversation.getId() }};
    
    messageForm.addEventListener("submit", function(event) {
        event.preventDefault();
        const formData = new FormData(messageForm);
        fetch(messageForm.action, {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                fetch(`{{ url('app_chat_fetch_message', {'id': conversation.id}) }}`)
                    .then(response => response.json())
                    .then(data => {
                        const messages = data.messages;
                        const length = data.messages.length;;
                        const messageElement = document.createElement("div");
                        messageElement.classList.add("message--current");
                        messageElement.textContent = messages[length-1].content;
                        messageContainer.appendChild(messageElement);
                    })
                    .catch(error => {
                        console.error("Error fetching messages:", error);
                    });
            }
        })
        .catch(error => {
            console.error("Error sending message:", error);
        });
    });
})
</script>

{% endblock %}

